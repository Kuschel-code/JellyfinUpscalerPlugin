<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AI Upscaler Plugin 1.4</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: transparent;
            color: inherit;
        }
        
        .pluginConfigurationPage {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .config-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0, 164, 220, 0.1), rgba(0, 164, 220, 0.05));
            border-radius: 12px;
            border: 2px solid rgba(0, 164, 220, 0.3);
        }
        
        .config-header h1 {
            color: #00a4dc;
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .config-header .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
            margin: 0;
        }
        
        .config-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .config-section h2 {
            color: #00a4dc;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 600;
            border-bottom: 3px solid rgba(0, 164, 220, 0.4);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #00a4dc;
            font-size: 1.1em;
        }
        
        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(0, 164, 220, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: inherit;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00a4dc;
            box-shadow: 0 0 0 3px rgba(0, 164, 220, 0.2);
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            margin-left: 10px;
            font-weight: 500;
        }
        
        .description {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            font-style: italic;
        }
        
        .button-group {
            text-align: center;
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }
        
        .btn {
            padding: 12px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00a4dc, #0080b3);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0080b3, #006699);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 164, 220, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #545b62, #424649);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        
        .success-message {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .info-card {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
            border: 2px solid rgba(40, 167, 69, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .info-card h3 {
            color: #28a745;
            margin: 0 0 10px 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .info-card p {
            margin: 0;
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="pluginConfigurationPage">
        <div class="config-header">
            <h1>üéÆ AI Upscaler Plugin</h1>
            <p class="subtitle">Version 1.4.0 - Ultimate AI Video Enhancement</p>
        </div>

        <div class="info-card">
            <h3>üöÄ Plugin Successfully Installed!</h3>
            <p>The AI Upscaler Plugin is now active and ready to enhance your videos. Configure your settings below and look for the "üéÆ AI" button in your video player.</p>
        </div>

        <form id="configForm">
            <div class="config-section">
                <h2>‚öôÔ∏è Basic Settings</h2>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="EnablePlugin" name="EnablePlugin" checked>
                    <label for="EnablePlugin">Enable AI Upscaler Plugin</label>
                </div>
                <div class="description">Master switch to enable or disable the plugin</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="PlayerButton" name="PlayerButton" checked>
                    <label for="PlayerButton">Show AI Button in Video Player</label>
                </div>
                <div class="description">Adds the AI upscaling button to video player controls</div>
                
                <div class="form-group">
                    <label for="Model">Default AI Model:</label>
                    <select id="Model" name="Model">
                        <option value="realesrgan" selected>Real-ESRGAN (Best Overall Quality)</option>
                        <option value="esrgan-pro">ESRGAN Pro (Movies & TV Shows)</option>
                        <option value="swinir">SwinIR (Complex Scenes)</option>
                        <option value="srcnn-light">SRCNN Light (Fast Processing)</option>
                        <option value="waifu2x">Waifu2x (Anime Content)</option>
                        <option value="hat">HAT (High Detail Enhancement)</option>
                        <option value="edsr">EDSR (Precise Upscaling)</option>
                        <option value="vdsr">VDSR (Deep Learning)</option>
                        <option value="rdn">RDN (Texture Enhancement)</option>
                        <option value="srresnet">SRResNet (Balanced Performance)</option>
                        <option value="carn">CARN (Compact & Fast)</option>
                        <option value="rrdbnet">RRDBNet (High Quality)</option>
                        <option value="drln">DRLN (Noise Reduction)</option>
                        <option value="fsrcnn">FSRCNN (Lightweight)</option>
                    </select>
                    <div class="description">Select the primary AI model for video upscaling</div>
                </div>
                
                <div class="grid-2col">
                    <div class="form-group">
                        <label for="ScaleFactor">Scale Factor:</label>
                        <select id="ScaleFactor" name="ScaleFactor">
                            <option value="2">2x Upscaling</option>
                            <option value="3" selected>3x Upscaling</option>
                            <option value="4">4x Upscaling</option>
                        </select>
                        <div class="description">Default upscaling factor</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="QualityLevel">Quality Level:</label>
                        <select id="QualityLevel" name="QualityLevel">
                            <option value="high">High Quality (Best Results)</option>
                            <option value="medium" selected>Medium Quality (Balanced)</option>
                            <option value="low">Low Quality (Fastest)</option>
                        </select>
                        <div class="description">Balance between quality and speed</div>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h2>üîß Hardware Settings</h2>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="HardwareAcceleration" name="HardwareAcceleration" checked>
                    <label for="HardwareAcceleration">Enable Hardware Acceleration</label>
                </div>
                <div class="description">Use GPU for faster processing when available</div>
                
                <div class="grid-2col">
                    <div class="form-group">
                        <label for="MaxVRAMUsage">Max VRAM Usage (MB):</label>
                        <input type="number" id="MaxVRAMUsage" name="MaxVRAMUsage" value="2048" min="512" max="16384">
                        <div class="description">Maximum VRAM to use for upscaling</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="CpuThreads">CPU Threads:</label>
                        <input type="number" id="CpuThreads" name="CpuThreads" value="4" min="1" max="32">
                        <div class="description">Number of CPU threads for processing</div>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h2>üéÆ Video Player Integration</h2>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="Notifications" name="Notifications" checked>
                    <label for="Notifications">Enable Progress Notifications</label>
                </div>
                <div class="description">Show upscaling progress notifications</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="AutoRetryButton" name="AutoRetryButton" checked>
                    <label for="AutoRetryButton">Auto-Retry Button Injection</label>
                </div>
                <div class="description">Automatically retry if AI button doesn't appear</div>
                
                <div class="form-group">
                    <label for="ButtonPosition">Button Position:</label>
                    <select id="ButtonPosition" name="ButtonPosition">
                        <option value="right" selected>Right Side</option>
                        <option value="left">Left Side</option>
                        <option value="center">Center</option>
                    </select>
                    <div class="description">Position of AI button in video player</div>
                </div>
            </div>

            <div class="config-section" id="hardware-status-section">
                <h2>üìä Live Hardware Status</h2>
                <div class="grid-2col">
                    <div class="info-card" style="background: rgba(0, 164, 220, 0.1); border-color: rgba(0, 164, 220, 0.3);">
                        <h3 style="color: #00a4dc;">CPU Status</h3>
                        <p id="cpu-status-text">Detecting...</p>
                    </div>
                    <div class="info-card" style="background: rgba(0, 164, 220, 0.1); border-color: rgba(0, 164, 220, 0.3);">
                        <h3 style="color: #00a4dc;">GPU Status</h3>
                        <p id="gpu-status-text">Detecting...</p>
                    </div>
                </div>
            </div>

            <div class="config-section" id="comparison-section">
                <h2>üîç AI Comparison Preview</h2>
                <div class="form-group">
                    <label for="comparison-item">Select Media Item for Preview:</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="comparison-item" style="flex-grow: 1; background: rgba(0, 164, 220, 0.1); border-color: rgba(0, 164, 220, 0.3);">
                            <option value="">Loading items...</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="generateComparison()" id="btn-compare" style="margin: 0; min-width: 150px;">
                            ‚ú® Generate Preview
                        </button>
                    </div>
                    <div class="description">Select a movie or episode to see a side-by-side AI upscaling comparison</div>
                </div>
                <div id="comparison-result" style="display: none; margin-top: 20px; animation: fadeIn 0.5s ease;">
                    <div class="grid-2col">
                        <div style="text-align: center;">
                            <h4 style="color: #00a4dc; margin-bottom: 10px;">Original Image</h4>
                            <div style="position: relative; overflow: hidden; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                <img id="img-original" style="width: 100%; display: block; filter: saturate(0.8);">
                                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">BEFORE</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: #00a4dc; margin-bottom: 10px;">AI Upscaled (x<span id="display-scale">2</span>)</h4>
                            <div style="position: relative; overflow: hidden; border-radius: 12px; border: 2px solid #00a4dc; box-shadow: 0 0 20px rgba(0, 164, 220, 0.3);">
                                <img id="img-upscaled" style="width: 100%; display: block;">
                                <div style="position: absolute; bottom: 10px; right: 10px; background: #00a4dc; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">AFTER</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                    üíæ Save Configuration
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetConfiguration()">
                    üîÑ Reset to Defaults
                </button>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        (function() {
            'use strict';
            
            // Configuration object with defaults
            var config = {
                EnablePlugin: true,
                PlayerButton: true,
                Model: 'realesrgan',
                ScaleFactor: 3,
                QualityLevel: 'medium',
                HardwareAcceleration: true,
                MaxVRAMUsage: 2048,
                CpuThreads: 4,
                Notifications: true,
                AutoRetryButton: true,
                ButtonPosition: 'right'
            };

            // Plugin ID for API calls
            var pluginId = 'f87f700e-679d-43e6-9c7c-b3a410dc3f22';

            // Initialize the configuration page
            function init() {
                console.log('AI Upscaler Plugin: Configuration page initializing...');
                loadConfiguration();
                updateUI();
                loadMediaItems();
                console.log('AI Upscaler Plugin: Configuration page loaded successfully');
            }

            // Load media items for comparison
            function loadMediaItems() {
                if (typeof ApiClient === 'undefined') return;
                
                console.log('AI Upscaler: Loading media items for comparison...');
                
                ApiClient.getItems(ApiClient.getCurrentUserId(), {
                    IncludeItemTypes: "Movie,Episode",
                    Recursive: true,
                    Limit: 15,
                    SortBy: "DateCreated",
                    SortOrder: "Descending",
                    ImageTypes: "Primary"
                }).then(function(result) {
                    var select = document.getElementById('comparison-item');
                    if (!select) return;
                    
                    select.innerHTML = '';
                    
                    if (result.Items && result.Items.length > 0) {
                        result.Items.forEach(function(item) {
                            var option = document.createElement('option');
                            option.value = item.Id;
                            option.textContent = item.Name + (item.ProductionYear ? ' (' + item.ProductionYear + ')' : '');
                            select.appendChild(option);
                        });
                        console.log('AI Upscaler: Loaded ' + result.Items.length + ' items for comparison');
                    } else {
                        var option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No items with images found";
                        select.appendChild(option);
                    }
                }).catch(function(error) {
                    console.error('AI Upscaler: Failed to load items -', error);
                });
            }

            // Generate AI comparison
            window.generateComparison = function() {
                var itemId = document.getElementById('comparison-item').value;
                if (!itemId) {
                    alert('Please select a media item first.');
                    return;
                }
                
                var btn = document.getElementById('btn-compare');
                var originalText = btn.innerHTML;
                btn.innerHTML = '‚åõ Processing AI...';
                btn.disabled = true;
                
                var model = document.getElementById('Model').value;
                var scale = document.getElementById('ScaleFactor').value;
                document.getElementById('display-scale').textContent = scale;
                
                var url = ApiClient.getUrl('api/Upscaler/compare/' + itemId, {
                    model: model,
                    scale: scale
                });
                
                console.log('AI Upscaler: Requesting comparison for item ' + itemId);
                
                ApiClient.getJSON(url).then(function(data) {
                    if (data && data.upscaledBase64) {
                        document.getElementById('img-original').src = data.originalBase64;
                        document.getElementById('img-upscaled').src = data.upscaledBase64;
                        document.getElementById('comparison-result').style.display = 'block';
                        
                        // Scroll to result
                        document.getElementById('comparison-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }).catch(function(error) {
                    console.error('AI Upscaler: Comparison failed -', error);
                    alert('AI Comparison failed: ' + (error.message || 'Unknown error'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            };

            // Load configuration from Jellyfin
            function loadConfiguration() {
                try {
                    // Try to load from Jellyfin API first
                    if (typeof ApiClient !== 'undefined' && ApiClient.getPluginConfiguration) {
                        ApiClient.getPluginConfiguration(pluginId).then(function(currentConfig) {
                            if (currentConfig) {
                                config = Object.assign(config, currentConfig);
                                updateUI();
                                console.log('AI Upscaler: Configuration loaded from Jellyfin API');
                            }
                        }).catch(function(error) {
                            console.log('AI Upscaler: Fallback to localStorage -', error);
                            loadFromLocalStorage();
                        });
                    } else {
                        loadFromLocalStorage();
                    }
                } catch (error) {
                    console.log('AI Upscaler: Error loading configuration -', error);
                    loadFromLocalStorage();
                }
            }

            // Load from localStorage as fallback
            function loadFromLocalStorage() {
                try {
                    var stored = localStorage.getItem('aiUpscalerConfig');
                    if (stored) {
                        config = Object.assign(config, JSON.parse(stored));
                        updateUI();
                        console.log('AI Upscaler: Configuration loaded from localStorage');
                    }
                } catch (error) {
                    console.log('AI Upscaler: Using default configuration');
                }
            }

            // Update UI with current configuration
            function updateUI() {
                Object.keys(config).forEach(function(key) {
                    var element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = !!config[key];
                        } else if (element.type === 'number') {
                            element.value = config[key] || 0;
                        } else {
                            element.value = config[key] || '';
                        }
                    }
                });
            }

            // Save configuration
            window.saveConfiguration = function() {
                try {
                    // Collect all form values
                    Object.keys(config).forEach(function(key) {
                        var element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                config[key] = element.checked;
                            } else if (element.type === 'number') {
                                config[key] = parseInt(element.value) || 0;
                            } else {
                                config[key] = element.value;
                            }
                        }
                    });

                    // Save to Jellyfin API
                    if (typeof ApiClient !== 'undefined' && ApiClient.updatePluginConfiguration) {
                        ApiClient.updatePluginConfiguration(pluginId, config).then(function() {
                            showSuccessMessage('‚úÖ Configuration saved successfully!');
                            injectPlayerButton();
                        }).catch(function(error) {
                            console.error('AI Upscaler: API save failed -', error);
                            fallbackSave();
                        });
                    } else {
                        fallbackSave();
                    }
                } catch (error) {
                    console.error('AI Upscaler: Save error -', error);
                    fallbackSave();
                }
            };

            // Fallback save method
            function fallbackSave() {
                try {
                    localStorage.setItem('aiUpscalerConfig', JSON.stringify(config));
                    showSuccessMessage('‚úÖ Configuration saved (fallback mode)');
                    injectPlayerButton();
                } catch (error) {
                    showErrorMessage('‚ùå Save failed: ' + error.message);
                }
            }

            // Reset to defaults
            window.resetConfiguration = function() {
                if (confirm('Reset all settings to defaults?')) {
                    config = {
                        EnablePlugin: true,
                        PlayerButton: true,
                        Model: 'realesrgan',
                        ScaleFactor: 3,
                        QualityLevel: 'medium',
                        HardwareAcceleration: true,
                        MaxVRAMUsage: 2048,
                        CpuThreads: 4,
                        Notifications: true,
                        AutoRetryButton: true,
                        ButtonPosition: 'right'
                    };
                    
                    updateUI();
                    showSuccessMessage('‚úÖ Settings reset to defaults');
                }
            };

            // Inject player button after save
            function injectPlayerButton() {
                if (!config.PlayerButton) return;
                
                // Use the API-based loading mechanism to avoid 404
                fetch(ApiClient.getUrl('api/Upscaler/js/player-integration.js'))
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.text();
                    })
                    .then(script => {
                        const existing = document.getElementById('aiupscaler-player');
                        if (existing) existing.remove();

                        const scriptElement = document.createElement('script');
                        scriptElement.id = 'aiupscaler-player';
                        scriptElement.textContent = script;
                        document.head.appendChild(scriptElement);
                        console.log('AI Upscaler: Player integration script updated');
                    })
                    .catch(error => console.log('Player integration load error:', error));
            }

            // Show success message
            function showSuccessMessage(message) {
                removeExistingMessage();
                
                var messageDiv = document.createElement('div');
                messageDiv.className = 'success-message';
                messageDiv.textContent = message;
                messageDiv.id = 'configMessage';
                
                var container = document.querySelector('.pluginConfigurationPage');
                container.insertBefore(messageDiv, container.firstChild);
                
                setTimeout(function() {
                    removeExistingMessage();
                }, 3000);
            }

            // Show error message
            function showErrorMessage(message) {
                removeExistingMessage();
                
                var messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'background: #dc3545; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600;';
                messageDiv.textContent = message;
                messageDiv.id = 'configMessage';
                
                var container = document.querySelector('.pluginConfigurationPage');
                container.insertBefore(messageDiv, container.firstChild);
                
                setTimeout(function() {
                    removeExistingMessage();
                }, 5000);
            }

            // Remove existing message
            function removeExistingMessage() {
                var existing = document.getElementById('configMessage');
                if (existing) {
                    existing.remove();
                }
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // Load Quick Menu and Player Integration
            function loadJavaScriptComponents() {
                try {
                    const components = [
                        { id: 'aiupscaler-sidebar', name: 'sidebar-upscaler.js' },
                        { id: 'aiupscaler-quickmenu', name: 'quick-menu.js' },
                        { id: 'aiupscaler-player', name: 'player-integration.js' }
                    ];

                    components.forEach(component => {
                        fetch(ApiClient.getUrl('api/Upscaler/js/' + component.name))
                            .then(response => {
                                if (!response.ok) throw new Error('Network response was not ok');
                                return response.text();
                            })
                            .then(script => {
                                // Remove existing script if any
                                const existing = document.getElementById(component.id);
                                if (existing) existing.remove();

                                const scriptElement = document.createElement('script');
                                scriptElement.id = component.id;
                                scriptElement.textContent = script;
                                document.head.appendChild(scriptElement);
                                console.log('AI Upscaler: Component ' + component.name + ' loaded');
                            })
                            .catch(error => console.log('Component ' + component.name + ' load error:', error));
                    });
                } catch (error) {
                    console.log('JavaScript components load error:', error);
                }
            }

            // Update Hardware Status from real API
            function updateHardwareStatus() {
                if (typeof ApiClient === 'undefined') return;

                ApiClient.getJSON(ApiClient.getUrl('api/Upscaler/recommendations')).then(function(data) {
                    if (data && data.hardwareInfo) {
                        document.getElementById('cpu-status-text').textContent = data.hardwareInfo.detectedCPU || 'Auto-detected';
                        document.getElementById('gpu-status-text').textContent = data.hardwareInfo.detectedGPU || 'Auto-detected';
                    }
                }).catch(function(error) {
                    console.error('Failed to update hardware status:', error);
                });
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    init();
                    updateHardwareStatus();
                    loadJavaScriptComponents();
                });
            } else {
                init();
                updateHardwareStatus();
                loadJavaScriptComponents();
            }
        })();
    </script>
</body>
</html>